<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Control Financiero</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .sheet-link {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .sheet-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; overflow-x: auto; }
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .tab.active { color: #667eea; border-bottom: 3px solid #667eea; background: white; }
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
        }
        .card h3 { font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; }
        .card .amount { font-size: 2em; font-weight: bold; }
        .card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .card.orange { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-container { background: #f8f9fa; padding: 20px; border-radius: 15px; }
        .form-container { background: #f8f9fa; padding: 30px; border-radius: 15px; max-width: 600px; margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #495057; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
        .btn-danger { background: #ff4d4d; color: white; }
        .btn-danger:hover { background: #e04343; }
        .btn-sm { padding: 6px 12px; font-size: 0.9em; }
        .table-container { overflow-x: auto; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 15px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th { background: #667eea; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8f9fa; }
        .modal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            width: 90%; 
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .sheet-link {
                position: static;
                display: block;
                margin-top: 15px;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>üí∞ Mi Control Financiero</h1>
            <p>Dashboard Interactivo</p>
            <a href="https://docs.google.com/spreadsheets/d/1Yw2ZOBNbHq6b2sSABmvZr22Sm9jQSO6XZ603wlZcql0/edit" 
               target="_blank" 
               class="sheet-link">
                üìä Ver Google Sheets
            </a>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('gastos')">üí∏ Gastos</button>
            <button class="tab" onclick="showTab('ingresos')">üíµ Ingresos</button>
            <button class="tab" onclick="showTab('cdts')">üè¶ CDTs</button>
        </div>

        <div class="content">
            <div id="dashboard" class="tab-content active">
                <div class="cards-grid">
                    <div class="card">
                        <h3>Total Gastos (Mes Actual)</h3>
                        <div class="amount" id="totalGastos">$0</div>
                    </div>
                    <div class="card green">
                        <h3>Total Ingresos (Mes Actual)</h3>
                        <div class="amount" id="totalIngresos">$0</div>
                    </div>
                    <div class="card blue">
                        <h3>Balance Mensual</h3>
                        <div class="amount" id="balance">$0</div>
                    </div>
                    <div class="card orange">
                        <h3>Total en CDTs</h3>
                        <div class="amount" id="totalCDTs">$0</div>
                    </div>
                </div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Gastos por Categor√≠a</h3>
                        <canvas id="chartCategories"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Ingresos vs Gastos</h3>
                        <canvas id="chartComparison"></canvas>
                    </div>
                </div>
            </div>

            <div id="gastos" class="tab-content">
                <div class="form-container">
                    <h3>Registrar Gasto</h3>
                    <form id="formGasto">
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="gastoFecha" required>
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n</label>
                            <input type="text" id="gastoDesc" required>
                        </div>
                        <div class="form-group">
                            <label>Categor√≠a</label>
                            <select id="gastoCategoria" required>
                                <option value="Comida">Comida</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Entretenimiento">Entretenimiento</option>
                                <option value="Salud">Salud</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Monto</label>
                            <input type="number" id="gastoMonto" required>
                        </div>
                        <div class="form-group">
                            <label>M√©todo de Pago</label>
                            <input type="text" id="gastoPago" placeholder="PSE, Nequi, Efectivo...">
                        </div>
                        <button type="submit" class="btn btn-primary">üíæ Guardar Gasto</button>
                    </form>
                </div>
                <div class="table-container">
                    <h3 style="margin-bottom: 15px;">Historial de Gastos</h3>
                    <div id="loadingGastos" class="loading">Cargando...</div>
                    <table id="tableGastos" style="display: none;">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Descripci√≥n</th>
                                <th>Categor√≠a</th>
                                <th>Monto</th>
                                <th>Pago</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="bodyGastos"></tbody>
                    </table>
                </div>
            </div>

            <div id="ingresos" class="tab-content">
                <div class="form-container">
                    <h3>Registrar Ingreso</h3>
                    <form id="formIngreso">
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="ingresoFecha" required>
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n</label>
                            <input type="text" id="ingresoDesc" required>
                        </div>
                        <div class="form-group">
                            <label>Monto</label>
                            <input type="number" id="ingresoMonto" required>
                        </div>
                        <div class="form-group">
                            <label>Fuente</label>
                            <input type="text" id="ingresoFuente" required>
                        </div>
                        <button type="submit" class="btn btn-primary">üíæ Guardar Ingreso</button>
                    </form>
                </div>
                <div class="table-container">
                    <h3 style="margin-bottom: 15px;">Historial de Ingresos</h3>
                    <div id="loadingIngresos" class="loading">Cargando...</div>
                    <table id="tableIngresos" style="display: none;">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Descripci√≥n</th>
                                <th>Monto</th>
                                <th>Fuente</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="bodyIngresos"></tbody>
                    </table>
                </div>
            </div>

            <div id="cdts" class="tab-content">
                <div class="form-container">
                    <h3>Nuevo CDT</h3>
                    <form id="formCDT">
                        <div class="form-group">
                            <label>Banco</label>
                            <input type="text" id="cdtBanco" required>
                        </div>
                        <div class="form-group">
                            <label>Monto</label>
                            <input type="number" id="cdtMonto" required>
                        </div>
                        <div class="form-group">
                            <label>Tasa (%)</label>
                            <input type="number" step="0.1" id="cdtTasa" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha Inicio</label>
                            <input type="date" id="cdtInicio" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin</label>
                            <input type="date" id="cdtFin" required>
                        </div>
                        <button type="submit" class="btn btn-primary">üíæ Guardar CDT</button>
                    </form>
                </div>
                <div class="table-container">
                    <h3 style="margin-bottom: 15px;">Mis CDTs</h3>
                    <div id="loadingCDTs" class="loading">Cargando...</div>
                    <table id="tableCDTs" style="display: none;">
                        <thead>
                            <tr>
                                <th>Banco</th>
                                <th>Monto</th>
                                <th>Tasa</th>
                                <th>Inicio</th>
                                <th>Fin</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="bodyCDTs"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modalEdit" class="modal">
        <div class="modal-content">
            <h3 id="editTitle">Editar Registro</h3>
            <form id="formEdit">
                <input type="hidden" id="editIndex">
                <input type="hidden" id="editType">
                <div id="editFields"></div>
                <div style="margin-top:20px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">‚úì Actualizar</button>
                    <button type="button" class="btn" onclick="closeModal()">‚úï Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbw2GtG5vsvvpg2dfNMnBFmiEOco6oiv7wOwhuQD3iJmxWh73PwrhU7W_OeqSZXWr7Rf/exec';

        let allData = { gastos: [], ingresos: [], cdts: [] };
        let chart1, chart2;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupForms();
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(i => i.value = today);
        });

        async function loadData() {
            try {
                const res = await fetch(API_URL);
                allData = await res.json();
                renderAll();
            } catch (e) { 
                alert("Error al conectar con Google Sheets. Verifica la URL del API."); 
                console.error(e);
            }
        }

        function cleanDate(dateStr) {
            if (!dateStr) return "";
            return dateStr.toString().substring(0, 10);
        }

        function renderAll() {
            renderGastos();
            renderIngresos();
            renderCDTs();
            updateDashboard();
        }

        function renderGastos() {
            const container = document.getElementById('bodyGastos');
            const data = allData.gastos || [];
            
            container.innerHTML = data.map(item => `
                <tr>
                    <td>${cleanDate(item.fecha)}</td>
                    <td>${item.descripcion || ''}</td>
                    <td>${item.categoria || ''}</td>
                    <td>${formatMoney(item.monto || 0)}</td>
                    <td>${item.pago || ''}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openEdit('Gasto', ${item.rowId})">‚úé Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('Gasto', ${item.rowId})">‚úñ Eliminar</button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('loadingGastos').style.display = 'none';
            document.getElementById('tableGastos').style.display = 'table';
        }

        function renderIngresos() {
            const container = document.getElementById('bodyIngresos');
            const data = allData.ingresos || [];
            
            container.innerHTML = data.map(item => `
                <tr>
                    <td>${cleanDate(item.fecha)}</td>
                    <td>${item.descripcion || ''}</td>
                    <td>${formatMoney(item.monto || 0)}</td>
                    <td>${item.fuente || ''}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openEdit('Ingreso', ${item.rowId})">‚úé Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('Ingreso', ${item.rowId})">‚úñ Eliminar</button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('loadingIngresos').style.display = 'none';
            document.getElementById('tableIngresos').style.display = 'table';
        }

        function renderCDTs() {
            const container = document.getElementById('bodyCDTs');
            const data = allData.cdts || [];
            
            container.innerHTML = data.map(item => `
                <tr>
                    <td>${item.banco || ''}</td>
                    <td>${formatMoney(item.monto || 0)}</td>
                    <td>${item.tasa || 0}%</td>
                    <td>${cleanDate(item.inicio)}</td>
                    <td>${cleanDate(item.fin)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openEdit('CDT', ${item.rowId})">‚úé Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('CDT', ${item.rowId})">‚úñ Eliminar</button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('loadingCDTs').style.display = 'none';
            document.getElementById('tableCDTs').style.display = 'table';
        }

        function showTab(name) {
            document.querySelectorAll('.tab-content, .tab').forEach(el => el.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            event.target.classList.add('active');
        }

        async function deleteItem(type, rowId) {
            if(!confirm("¬øEst√°s seguro de eliminar este registro?")) return;
            
            try {
                await send({ action: 'delete' + type, index: rowId });
                alert('Registro eliminado exitosamente');
            } catch(e) {
                alert('Error al eliminar: ' + e.message);
            }
        }

        function openEdit(type, rowId) {
            const listName = type.toLowerCase() + 's';
            const item = allData[listName].find(i => i.rowId === rowId);
            
            if (!item) {
                alert('Registro no encontrado');
                return;
            }
            
            document.getElementById('editIndex').value = rowId;
            document.getElementById('editType').value = 'update' + type;
            document.getElementById('editTitle').textContent = 'Editar ' + type;
            
            const fields = document.getElementById('editFields');
            let html = '';
            
            Object.keys(item).forEach(k => {
                if(k === 'rowId') return;
                
                let val = item[k];
                let inputType = "text";
                let label = k.charAt(0).toUpperCase() + k.slice(1);
                
                if(k.toLowerCase().includes('fecha') || k === 'inicio' || k === 'fin') {
                    val = cleanDate(val);
                    inputType = "date";
                } else if(k === 'monto' || k === 'tasa') {
                    inputType = "number";
                    if(k === 'tasa') inputType = "number\" step=\"0.1";
                } else if(k === 'categoria') {
                    html += `
                        <div class="form-group">
                            <label>${label}</label>
                            <select name="${k}" class="form-control">
                                <option value="Comida" ${val === 'Comida' ? 'selected' : ''}>Comida</option>
                                <option value="Transporte" ${val === 'Transporte' ? 'selected' : ''}>Transporte</option>
                                <option value="Servicios" ${val === 'Servicios' ? 'selected' : ''}>Servicios</option>
                                <option value="Entretenimiento" ${val === 'Entretenimiento' ? 'selected' : ''}>Entretenimiento</option>
                                <option value="Salud" ${val === 'Salud' ? 'selected' : ''}>Salud</option>
                                <option value="Otros" ${val === 'Otros' ? 'selected' : ''}>Otros</option>
                            </select>
                        </div>
                    `;
                    return;
                }
                
                html += `
                    <div class="form-group">
                        <label>${label}</label>
                        <input name="${k}" type="${inputType}" value="${val || ''}" class="form-control">
                    </div>
                `;
            });
            
            fields.innerHTML = html;
            document.getElementById('modalEdit').classList.add('active');
        }

        function closeModal() { 
            document.getElementById('modalEdit').classList.remove('active'); 
        }

        async function send(payload) {
            try {
                const res = await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify(payload) 
                });
                const result = await res.json();
                
                if(result.success) {
                    await loadData();
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
            } catch (e) { 
                console.error(e);
                throw e;
            }
        }

        function setupForms() {
            document.getElementById('formGasto').onsubmit = async (e) => {
                e.preventDefault();
                try {
                    await send({
                        action: 'addGasto',
                        fecha: document.getElementById('gastoFecha').value,
                        descripcion: document.getElementById('gastoDesc').value,
                        categoria: document.getElementById('gastoCategoria').value,
                        monto: Number(document.getElementById('gastoMonto').value),
                        pago: document.getElementById('gastoPago').value
                    });
                    e.target.reset();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('gastoFecha').value = today;
                    alert('Gasto guardado exitosamente');
                } catch(err) {
                    alert('Error al guardar: ' + err.message);
                }
            };

            document.getElementById('formIngreso').onsubmit = async (e) => {
                e.preventDefault();
                try {
                    await send({
                        action: 'addIngreso',
                        fecha: document.getElementById('ingresoFecha').value,
                        descripcion: document.getElementById('ingresoDesc').value,
                        monto: Number(document.getElementById('ingresoMonto').value),
                        fuente: document.getElementById('ingresoFuente').value
                    });
                    e.target.reset();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('ingresoFecha').value = today;
                    alert('Ingreso guardado exitosamente');
                } catch(err) {
                    alert('Error al guardar: ' + err.message);
                }
            };

            document.getElementById('formCDT').onsubmit = async (e) => {
                e.preventDefault();
                try {
                    await send({
                        action: 'addCDT',
                        banco: document.getElementById('cdtBanco').value,
                        monto: Number(document.getElementById('cdtMonto').value),
                        tasa: Number(document.getElementById('cdtTasa').value),
                        inicio: document.getElementById('cdtInicio').value,
                        fin: document.getElementById('cdtFin').value
                    });
                    e.target.reset();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('cdtInicio').value = today;
                    alert('CDT guardado exitosamente');
                } catch(err) {
                    alert('Error al guardar: ' + err.message);
                }
            };

            document.getElementById('formEdit').onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const payload = Object.fromEntries(formData.entries());
                payload.action = document.getElementById('editType').value;
                payload.index = document.getElementById('editIndex').value;
                
                try {
                    closeModal();
                    await send(payload);
                    alert('Registro actualizado exitosamente');
                } catch(err) {
                    alert('Error al actualizar: ' + err.message);
                }
            };
        }

        function formatMoney(n) { 
            return new Intl.NumberFormat('es-CO', { 
                style: 'currency', 
                currency: 'COP', 
                maximumFractionDigits: 0 
            }).format(n); 
        }

        function updateDashboard() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const gastosMonth = (allData.gastos || []).filter(g => {
                const date = new Date(g.fecha);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            const ingresosMonth = (allData.ingresos || []).filter(i => {
                const date = new Date(i.fecha);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            const tg = gastosMonth.reduce((s, i) => s + (i.monto || 0), 0);
            const ti = ingresosMonth.reduce((s, i) => s + (i.monto || 0), 0);
            const tc = (allData.cdts || []).reduce((s, i) => s + (i.monto || 0), 0);
            
            document.getElementById('totalGastos').innerText = formatMoney(tg);
            document.getElementById('totalIngresos').innerText = formatMoney(ti);
            document.getElementById('balance').innerText = formatMoney(ti - tg);
            document.getElementById('totalCDTs').innerText = formatMoney(tc);

            // Gr√°fico de categor√≠as
            const categorias = {};
            gastosMonth.forEach(g => {
                const cat = g.categoria || 'Sin categor√≠a';
                categorias[cat] = (categorias[cat] || 0) + g.monto;
            });

            if(chart1) chart1.destroy();
            chart1 = new Chart(document.getElementById('chartCategories'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [{
                        data: Object.values(categorias),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#11998e', '#38ef7d',
                            '#4facfe', '#00f2fe', '#fa709a', '#fee140'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Gr√°fico de comparaci√≥n
            if(chart
