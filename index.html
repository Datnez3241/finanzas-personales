<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control Financiero - Corregido</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .form-section { background: #e9ecef; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: #4a69bd; color: white; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-add { background: #2ecc71; }
        .btn-edit { background: #f1c40f; color: black; margin-right: 5px; }
        .btn-del { background: #e74c3c; }
        .btn-update { background: #3498db; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ’¸ Mis Gastos</h2>
    
    <div class="form-section">
        <h3 id="formTitle">Agregar Nuevo Gasto</h3>
        <form id="gastoForm">
            <input type="hidden" id="editIndex">
            <div class="grid-form">
                <input type="date" id="fecha" required>
                <input type="text" id="descripcion" placeholder="DescripciÃ³n" required>
                <select id="categoria">
                    <option value="Comida">Comida</option>
                    <option value="Servicios">Servicios</option>
                    <option value="Hogar">Hogar</option>
                    <option value="Transporte">Transporte</option>
                </select>
                <input type="number" id="monto" placeholder="Monto" required>
                <select id="pago">
                    <option value="Efectivo">Efectivo</option>
                    <option value="Tarjeta">Tarjeta</option>
                    <option value="Transferencia">Transferencia</option>
                </select>
            </div>
            <div style="margin-top:15px;">
                <button type="submit" id="submitBtn" class="btn btn-add">Guardar Gasto</button>
                <button type="button" id="cancelBtn" class="btn btn-del hidden" onclick="resetForm()">Cancelar</button>
            </div>
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>DescripciÃ³n</th>
                <th>CategorÃ­a</th>
                <th>Monto</th>
                <th>Pago</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tablaGastos"></tbody>
    </table>
</div>

<script>
    const API_URL = 'TU_NUEVA_URL_AQUI'; // <--- PEGA TU URL DE IMPLEMENTACIÃ“N AQUÃ
    let gastosLocal = [];

    async function cargarDatos() {
        const res = await fetch(API_URL + '?action=getAll');
        const data = await res.json();
        gastosLocal = data.gastos;
        renderTabla();
    }

    function renderTabla() {
        const tbody = document.getElementById('tablaGastos');
        tbody.innerHTML = '';
        gastosLocal.forEach((g, i) => {
            tbody.innerHTML += `
                <tr>
                    <td>${g.fecha}</td>
                    <td>${g.descripcion || '---'}</td>
                    <td>${g.categoria || '---'}</td>
                    <td>$${Number(g.monto).toLocaleString()}</td>
                    <td>${g.pago || '---'}</td>
                    <td>
                        <button class="btn btn-edit" onclick="prepararEdicion(${i})">Editar</button>
                        <button class="btn btn-del" onclick="eliminar(${i + 2})">Eliminar</button>
                    </td>
                </tr>`;
        });
    }

    function prepararEdicion(index) {
        const g = gastosLocal[index];
        document.getElementById('editIndex').value = index + 2; // Fila en Excel
        document.getElementById('fecha').value = g.fecha;
        document.getElementById('descripcion').value = g.descripcion;
        document.getElementById('categoria').value = g.categoria;
        document.getElementById('monto').value = g.monto;
        document.getElementById('pago').value = g.pago;

        document.getElementById('formTitle').innerText = "Editando Gasto...";
        document.getElementById('submitBtn').innerText = "Actualizar Cambios";
        document.getElementById('submitBtn').classList.replace('btn-add', 'btn-update');
        document.getElementById('cancelBtn').classList.remove('hidden');
        window.scrollTo(0,0);
    }

    document.getElementById('gastoForm').onsubmit = async (e) => {
        e.preventDefault();
        const index = document.getElementById('editIndex').value;
        const payload = {
            action: index ? 'updateGasto' : 'addGasto',
            index: index ? parseInt(index) : null,
            fecha: document.getElementById('fecha').value,
            descripcion: document.getElementById('descripcion').value,
            categoria: document.getElementById('categoria').value,
            monto: document.getElementById('monto').value,
            pago: document.getElementById('pago').value
        };

        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        resetForm();
        cargarDatos();
    };

    function resetForm() {
        document.getElementById('gastoForm').reset();
        document.getElementById('editIndex').value = '';
        document.getElementById('formTitle').innerText = "Agregar Nuevo Gasto";
        document.getElementById('submitBtn').innerText = "Guardar Gasto";
        document.getElementById('submitBtn').classList.replace('btn-update', 'btn-add');
        document.getElementById('cancelBtn').classList.add('hidden');
    }

    async function eliminar(fila) {
        if(confirm('Â¿Seguro que quieres eliminar este gasto?')) {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'deleteGasto', index: fila}) });
            cargarDatos();
        }
    }

    cargarDatos();
</script>

</body>
</html>
